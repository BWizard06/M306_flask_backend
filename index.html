<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>&#128196; M306 Projekt</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.src.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100 font-sans min-h-screen">
    <header class="bg-blue-500 text-white py-4">
      <div class="max-w-2xl mx-auto text-center">
        <h1 class="text-3xl font-bold">&#128196; M306 Projekt</h1>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
      <section class="bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-2xl mb-4">&#128640; Process XML Files</h2>
        <form id="xmlForm" class="flex space-x-4">
          <input
            type="text"
            name="sdat"
            id="sdat"
            class="flex-grow border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500 transition duration-300"
          />
          <input
            type="text"
            name="esl"
            id="esl"
            class="flex-grow border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500 transition duration-300"
          />
          <div class="block">
            <button
              type="submit"
              id="processButton"
              class="bg-blue-500 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-700 transition duration-300"
            >
              Process XML Files
            </button>
            <button
              id="toggleButton"
              class="bg-blue-500 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-700 transition duration-300"
            >
              Verbrauchsdiagramm
            </button>
            <div id="dateRangeContainer" class="flex items-center space-x-4">
              <button
                id="leftButton"
                class="bg-gray-300 text-gray-700 px-4 py-2 rounded cursor-pointer hover:bg-gray-400 transition duration-300"
                disabled
              >
                &lt;
                <!-- Left Arrow -->
              </button>
              <div id="dateRangeDisplay" class="font-bold text-lg">
                Date Range
              </div>
              <button
                id="rightButton"
                class="bg-gray-300 text-gray-700 px-4 py-2 rounded cursor-pointer hover:bg-gray-400 transition duration-300"
                disabled
              >
                &gt;
                <!-- Right Arrow -->
              </button>
              <button
                id="downloadButton"
                class="bg-gray-300 text-gray-700 px-4 py-2 rounded cursor-pointer hover:bg-gray-400 transition duration-300"
                disabled
              >
                Download CSV
              </button>
            </div>
          </div>
        </form>
      </section>

      <section class="mt-8 min-h-screen w-full">
        <h2 class="text-2xl">&#128202; Results:</h2>
        <div
          id="chart"
          class="bg-white min-h-screen p-4 mt-4 rounded-lg shadow-md"
        ></div>
      </section>
    </main>

    <footer class="bg-blue-500 text-white text-center py-4">
      &copy; 2023 M306 Projekt
    </footer>
    <script>
      // Variables to keep track of the current chart type, data, and date range
      let currentChartType = "Verbrauchsdiagramm";
      let currentChartData = null;
      let startDate = ""; // Store the start date
      let endDate = ""; // Store the end date

      // Function to toggle between chart types
      function toggleChartType() {
        const toggleButton = document.getElementById("toggleButton");

        if (currentChartType === "Verbrauchsdiagramm") {
          currentChartType = "Z&#228;hlerstandsdiagramm";
        } else {
          currentChartType = "Verbrauchsdiagramm";
        }

        toggleButton.innerHTML = currentChartType;

        // Clear the chart content
        document.getElementById("chart").innerHTML = "";

        // Clear the currentChartData
        currentChartData = null;
      }

      document
        .getElementById("toggleButton")
        .addEventListener("click", toggleChartType);

      // Add an event listener to the form submission
      const xmlForm = document.getElementById("xmlForm");
      xmlForm.addEventListener("submit", async function (event) {
        event.preventDefault();

        // Disable the submit button
        const processButton = document.getElementById("processButton");
        processButton.disabled = true;

        let verzeichnis;

        if (currentChartType === "Verbrauchsdiagramm") {
          verzeichnis = document.getElementById("sdat").value;
        } else {
          verzeichnis = document.getElementById("esl").value;
        }

        try {
          const response = await fetch(
            `http://localhost:5000/${
              currentChartType === "Verbrauchsdiagramm" ? "sdat" : "esl"
            }?${
              currentChartType === "Verbrauchsdiagramm" ? "sdat" : "esl"
            }=${verzeichnis}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
          const data = await response.json();

          const downloadButton = document.getElementById("downloadButton");

          // Remove disabled property
          downloadButton.removeAttribute("disabled");

          // Change tailwindcss classes to enable button
          downloadButton.classList = "bg-blue-500 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-700 transition duration-300";

          console.log(data);
          currentChartData = data;

          // Extract the start and end dates from the data (replace with your logic)
          if (data.length > 0) {
            startDate = data[0].timestamp; // Assuming timestamp is in 'YYYY-MM-DD' format
            endDate = data[data.length - 1].timestamp;
          } else {
            startDate = endDate = "No data available";
          }

          // Display the date range
          updateDateRangeDisplay();

          // Highcharts chart with zooming, tooltip, and other features
          const chart = Highcharts.chart("chart", {
            chart: {
              zoomType: "x", // Enable zooming on the x-axis
            },
            title: {
              text: `&#128200; ${currentChartType}`,
            },
            xAxis: {
              type: "datetime",
              title: {
                text: "Timestamp",
              },
              labels: {
                formatter: function () {
                  return Highcharts.dateFormat("%Y-%m-%d %H:%M:%S", this.value);
                },
              },
            },
            yAxis: {
              title: {
                text: "Value",
              },
            },
            tooltip: {
              shared: true, // Show shared tooltip for multiple series
              xDateFormat: "%Y-%m-%d %H:%M:%S", // Format for timestamp in tooltip
            },
            series: [
              {
                name: "Value Bezug",
                data: data.map((item) => [
                  new Date(item.timestamp).getTime(),
                  parseFloat(item.value_bezug),
                ]),
                color: "red",
              },
              {
                name: "Value Geben",
                data: data.map((item) => [
                  new Date(item.timestamp).getTime(),
                  parseFloat(item.value_geben),
                ]),
                color: "blue",
              },
            ],
            plotOptions: {
              series: {
                marker: {
                  enabled: true, // Show markers on data points
                  radius: 3, // Marker size
                },
              },
            },
            annotations: [
              {
                labelOptions: {
                  backgroundColor: "rgba(255, 255, 255, 0.8)",
                  shape: "rect",
                  padding: 5,
                },
                labels: [
                  {
                    point: {
                      xAxis: 0,
                      yAxis: 0,
                      x: new Date().getTime(), // Add an annotation at the current time
                      y: 0, // You can customize the y-coordinate as needed
                    },
                    text: "Current Time",
                  },
                ],
              },
            ],
            boost: {
              enabled: true, // Enable boost module for better performance
              useGPUTranslations: true, // Use GPU translations for smoother zooming
            },
            exporting: {
              enabled: true, // Enable exporting options
            },
          });

          function downlaodCsv() {
            chart.downloadCSV();
          }

          // Enable the left and right buttons for date navigation
          document.getElementById("leftButton").disabled = false;
          document.getElementById("rightButton").disabled = false;

          document
            .getElementById("downloadButton")
            .addEventListener("click", downlaodCsv);
        } catch (error) {
          console.error("Error:", error);
        } finally {
          // Enable the submit button after the fetch request completes or encounters an error
          processButton.disabled = false;
        }
      });

      // Add an event listener to the left button for navigating one day back
      const leftButton = document.getElementById("leftButton");
      leftButton.addEventListener("click", function () {
        if (!currentChartData || currentChartData.length === 0) {
          alert("No data available");
          return;
        }

        // Calculate the new start and end dates
        const newStartDate = new Date(startDate);
        newStartDate.setDate(newStartDate.getDate() - 1);

        // Check if the new start date is still within the data range
        if (newStartDate >= new Date(currentChartData[0].timestamp)) {
          startDate = newStartDate.toISOString().slice(0, 10); // Format as 'YYYY-MM-DD'
          endDate = newStartDate.toISOString().slice(0, 10);

          // Update the date range display
          updateDateRangeDisplay();

          // Update the chart with the new date range
          updateChartWithDateRange(startDate, endDate);
        } else {
          alert("No data available for the previous day");
        }
      });

      // Add an event listener to the right button for navigating one day forward
      const rightButton = document.getElementById("rightButton");
      rightButton.addEventListener("click", function () {
        if (!currentChartData || currentChartData.length === 0) {
          alert("No data available");
          return;
        }

        // Calculate the new start and end dates
        const newEndDate = new Date(endDate);
        newEndDate.setDate(newEndDate.getDate() + 1);

        // Check if the new end date is still within the data range
        if (
          newEndDate <=
          new Date(currentChartData[currentChartData.length - 1].timestamp)
        ) {
          startDate = newEndDate.toISOString().slice(0, 10); // Format as 'YYYY-MM-DD'
          endDate = newEndDate.toISOString().slice(0, 10);

          // Update the date range display
          updateDateRangeDisplay();

          // Update the chart with the new date range
          updateChartWithDateRange(startDate, endDate);
        } else {
          alert("No data available for the next day");
        }
      });

      // Function to update the date range display
      function updateDateRangeDisplay() {
        const dateRangeDisplay = document.getElementById("dateRangeDisplay");
        dateRangeDisplay.textContent = `${startDate} - ${endDate}`;
      }

      // Initial date range display
      updateDateRangeDisplay();
    </script>
  </body>
</html>
